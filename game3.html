<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game 3 - Ø£Ù„ØºØ§Ø² Ø§Ù„Ø¨Ø­Ø±</title>
  <style>
    body{margin:0;font-family:system-ui;background:#160614;color:#fff;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:18px}
    .card{width:min(980px,96vw);background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:22px;overflow:hidden}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:14px;border-bottom:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.20);flex-wrap:wrap}
    .pill{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-weight:900}
    .btn{padding:10px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.08);color:#fff;font-weight:900;cursor:pointer}
    .btnWhite{background:#fff;color:#111;border:0}
    .inner{padding:16px}
    .title{border-radius:18px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.16);padding:14px;text-align:center;font-weight:900}
    .sea{margin-top:12px;border-radius:18px;border:1px solid rgba(255,255,255,.14);background:linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,.22));padding:16px}
    .riddle{border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);padding:16px;text-align:center;font-size:18px;line-height:2;min-height:74px;display:flex;align-items:center;justify-content:center}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}
    .box{border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.14);padding:14px}
    .head{font-weight:900;text-align:center;line-height:1.8;margin-bottom:10px}
    input{width:100%;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);color:#fff;outline:none;font-size:15px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .row .btn{flex:1 1 180px}
    .hint{margin-top:10px;color:rgba(255,255,255,.75);text-align:center;font-size:13px;line-height:1.9}
    .status{margin-top:10px;color:rgba(255,255,255,.72);text-align:center;font-size:12px;line-height:1.9}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-weight:900;font-size:12px}
  </style>
</head>

<body>
  <div class="card">
    <div class="top">
      <div class="pill" id="who">ğŸŒŠ ...</div>
      <div style="display:flex;gap:10px">
        <button class="btn" id="home">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="btn btnWhite" id="logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="inner">
      <div class="title">ğŸŒŠ Ø£Ù„ØºØ§Ø² Ø§Ù„Ø¨Ø­Ø± (Live) â€” ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙŠØ­Ù„ ÙˆØ¨Ø¹Ø¯ÙŠÙ† Ù†ÙƒØ´Ù</div>

      <div class="sea">
        <div class="riddle" id="riddle">Ø§Ø¶ØºØ· (Ù„ØºØ² Ø¬Ø¯ÙŠØ¯) ğŸš</div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="newRiddle">ğŸš Ù„ØºØ² Ø¬Ø¯ÙŠØ¯</button>
          <button class="btn" id="reveal">ğŸ‘€ ÙƒØ´Ù Ø§Ù„Ø­Ù„</button>
        </div>

        <div class="hint">
          Ø§Ù„ÙÙƒØ±Ø©: ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙŠÙƒØªØ¨ ØªØ®Ù…ÙŠÙ†Ù‡â€¦ ÙˆÙ…Ø§ ÙŠÙ†ÙƒØ´Ù Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø¶ØºØ·Øª â€œÙƒØ´Ù Ø§Ù„Ø­Ù„â€ âœ…
        </div>
      </div>

      <div class="grid">
        <div class="box">
          <div class="head">ØªØ®Ù…ÙŠÙ†Ùƒ Ø£Ù†Øª <span class="chip" id="meTag">â€”</span></div>
          <input id="meGuess" placeholder="Ø§ÙƒØªØ¨ ØªØ®Ù…ÙŠÙ†Ùƒâ€¦" />
          <div class="row">
            <button class="btn btnWhite" id="saveGuess">ğŸ’¾ Ø­ÙØ¸ ØªØ®Ù…ÙŠÙ†ÙŠ (Live)</button>
          </div>
          <div class="hint">Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø©/Ø¬Ù…Ù„Ø© Ù‚ØµÙŠØ±Ø©.</div>
        </div>

        <div class="box">
          <div class="head">ØªØ®Ù…ÙŠÙ† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ <span class="chip" id="otherTag">â€”</span></div>
          <input id="otherGuess" readonly value="ğŸ”’ Ù…Ø®ÙÙŠ Ù„ÙŠÙ† ØªÙƒØ´ÙÙˆÙ†" />
          <div class="hint">Ù…Ø§ ÙŠØ¨Ø§Ù† Ø¥Ù„Ø§ Ø¹Ù†Ø¯ â€œÙƒØ´Ù Ø§Ù„Ø­Ù„â€.</div>
        </div>
      </div>

      <div class="status" id="status">â€¦</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBTr4NrjrEq3Lh23PIJ_Zz-KRr6yqgafyU",
      authDomain: "lanasnas-8de50.firebaseapp.com",
      projectId: "lanasnas-8de50",
      storageBucket: "lanasnas-8de50.firebasestorage.app",
      messagingSenderId: "847037285771",
      appId: "1:847037285771:web:096d4a14a984de41955b8e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ROOM_ID = "our-world";
    const roomRef = doc(db, "rooms", ROOM_ID);

    const who = document.getElementById("who");
    const status = document.getElementById("status");
    const riddleEl = document.getElementById("riddle");
    const meGuess = document.getElementById("meGuess");
    const otherGuess = document.getElementById("otherGuess");
    const meTag = document.getElementById("meTag");
    const otherTag = document.getElementById("otherTag");

    const RIDDLES = [
      {q:"Ø´ÙŠØ¡ ÙÙŠ Ø§Ù„Ø¨Ø­Ø±.. Ù„Ù‡ Ø£Ø³Ù†Ø§Ù† ÙˆÙ„Ø§ ÙŠØ¹Ø¶ØŸ", a:"Ø§Ù„Ù…Ø´Ø·"},
      {q:"ÙŠÙ…Ø´ÙŠ Ø¨Ù„Ø§ Ø±Ø¬Ù„ÙŠÙ†.. ÙˆÙŠØ¯Ø®Ù„ Ø§Ù„Ù…Ø§Ø¡ ÙˆÙ…Ø§ ÙŠØ¨ØªÙ„ØŸ", a:"Ø§Ù„Ø¶ÙˆØ¡"},
      {q:"Ø´ÙŠØ¡ Ø¥Ø°Ø§ Ø£Ø®Ø°Øª Ù…Ù†Ù‡ ÙƒØ¨Ø±.. ÙˆØ´ Ù‡ÙˆØŸ", a:"Ø§Ù„Ø­ÙØ±Ø©"},
      {q:"Ù„Ù‡ Ø¹ÙŠÙ† ÙˆØ­Ø¯Ø© ÙˆÙ…Ø§ ÙŠØ´ÙˆÙ.. Ù…Ù† Ù‡ÙˆØŸ", a:"Ø§Ù„Ø¥Ø¨Ø±Ø©"},
      {q:"Ø£Ø³Ù…Ø¹Ùƒ ÙˆÙ„Ø§ Ø£Ø´ÙˆÙÙƒ.. ÙˆØ¥Ø°Ø§ Ø´ÙØªÙƒ Ø§Ø®ØªÙÙŠØª.. ÙˆØ´ Ø£Ù†Ø§ØŸ", a:"Ø§Ù„ØµØ¯Ù‰"},
      {q:"Ø¹Ù„Ù‰ Ø¸Ù‡Ø±Ù‡ Ø¨ÙŠØª ÙˆÙŠØ­Ù…Ù„ Ù†ÙØ³Ù‡.. Ù…Ù† Ù‡ÙˆØŸ", a:"Ø§Ù„Ø³Ù„Ø­ÙØ§Ø©"},
      {q:"Ø´ÙŠØ¡ ÙƒÙ„ Ù…Ø§ Ø²Ø§Ø¯ Ù†Ù‚Øµ.. ÙˆØ´ Ù‡ÙˆØŸ", a:"Ø§Ù„Ø¹Ù…Ø±"},
      {q:"ÙŠÙ…ØªÙ„Ø¦ ÙƒÙ„Ù…Ø§ Ø£ÙÙØ±Øº.. ÙˆØ´ Ù‡ÙˆØŸ", a:"Ø§Ù„Ø¨Ø¦Ø±"}
    ];

    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    let currentName = null; // "ANAS" | "LANA"
    function myKey(){ return (currentName==="ANAS") ? "anas" : "lana"; }
    function otherKey(){ return (currentName==="ANAS") ? "lana" : "anas"; }
    function mySavedKey(){ return (currentName==="ANAS") ? "savedAnas" : "savedLana"; }
    function otherSavedKey(){ return (currentName==="ANAS") ? "savedLana" : "savedAnas"; }

    async function ensureRoom(){
      await setDoc(roomRef, {
        roomId: ROOM_ID,
        g3: {
          q: "",
          a: "",
          anas: "",
          lana: "",
          savedAnas: false,
          savedLana: false,
          revealed: false,
          updatedBy: "system"
        },
        updatedAt: serverTimestamp()
      }, { merge:true });
    }

    function safeSetInput(el, v){
      if(!el) return;
      if(document.activeElement===el) return;
      el.value = (typeof v==="string") ? v : "";
    }

    async function push(payload){
      await updateDoc(roomRef, { ...payload, updatedAt: serverTimestamp() });
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "index.html";
        return;
      }
      const em = (user.email||"").toLowerCase();
      currentName = em.startsWith("lana") ? "LANA" : "ANAS";
      who.textContent = `ğŸŒŠ Ø£Ù†Øª: ${currentName}`;
      meTag.textContent = currentName;
      otherTag.textContent = (currentName==="ANAS") ? "LANA" : "ANAS";

      await ensureRoom();

      onSnapshot(roomRef, (snap)=>{
        const data = snap.data() || {};
        const g3 = data.g3 || {};

        riddleEl.textContent = g3.q ? `ğŸš ${g3.q}` : "Ø§Ø¶ØºØ· (Ù„ØºØ² Ø¬Ø¯ÙŠØ¯) ğŸš";

        safeSetInput(meGuess, g3[myKey()] || "");

        const otherTxt = g3.revealed ? (g3[otherKey()] || "â€”") : "ğŸ”’ Ù…Ø®ÙÙŠ Ù„ÙŠÙ† ØªÙƒØ´ÙÙˆÙ†";
        otherGuess.value = otherTxt;

        const solvedMe = g3[mySavedKey()] ? "âœ…" : "â€”";
        const solvedOther = g3[otherSavedKey()] ? "âœ…" : "â€”";
        status.textContent =
          `Live âœ… | Ø­Ù„Ù‘ ${currentName}: ${solvedMe} | Ø­Ù„Ù‘ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ: ${solvedOther} | ÙƒØ´Ù: ${g3.revealed ? "âœ…" : "â€”"} | Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${g3.updatedBy || "â€”"}`;
      });
    });

    document.getElementById("newRiddle").onclick = async ()=>{
      const item = pick(RIDDLES);
      await push({
        "g3.q": item.q,
        "g3.a": item.a,
        "g3.anas": "",
        "g3.lana": "",
        "g3.savedAnas": false,
        "g3.savedLana": false,
        "g3.revealed": false,
        "g3.updatedBy": currentName || "unknown"
      });
    };

    document.getElementById("saveGuess").onclick = async ()=>{
      const txt = (meGuess.value||"").trim();
      if(!txt){ status.textContent="Ø§ÙƒØªØ¨ ØªØ®Ù…ÙŠÙ†Ùƒ Ø£ÙˆÙ„Ø§Ù‹ âœï¸"; return; }
      const payload = {};
      payload[`g3.${myKey()}`] = txt;
      payload[`g3.${mySavedKey()}`] = true;
      payload["g3.updatedBy"] = currentName || "unknown";
      await push(payload);
    };

    document.getElementById("reveal").onclick = async ()=>{
      await push({
        "g3.revealed": true,
        "g3.updatedBy": currentName || "unknown"
      });
    };

    document.getElementById("home").onclick = ()=> location.href = "index.html";

    document.getElementById("logout").onclick = async ()=>{
      try{ await signOut(auth); }catch(e){}
      location.href = "index.html";
    };
  </script>
</body>
</html>
